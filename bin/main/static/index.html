<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PlayPay</title>

  <!-- Playful rounded font -->
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="site-header" role="banner">
    <a class="logo" href="/" aria-label="PlayPay home">
      <!-- header icon image (static/header-icon.png) -->
      <img src="/header-icon.png" alt="PlayPay" class="logo-img" />
      <span class="logo-text">PlayPay</span>
    </a>
  </header>

  <main class="main-content">
    <h1 id="top" class="main-title">PlayPay</h1>

    <section class="auth-section">
      <h2>Who are you?</h2>

      <div class="role-choices">
        <button id="btn-child" class="role-btn" onclick="selectRole('child')">I'm a Child</button>
        <button id="btn-parent" class="role-btn" onclick="selectRole('parent')">I'm a Parent</button>
      </div>

      <div id="child-form" class="auth-form hidden">
        <label>Join Code:
          <input id="child-join-code" placeholder="Enter join code" />
        </label>
        <button class="primary" onclick="joinAsChild()">Join</button>
      </div>

      <div id="parent-form" class="auth-form hidden">
        <h2>Household</h2>

        <div class="role-choices"> 
          <button class="role-btn" onclick="showParentMode('create')" id="parent-create-btn">Create Household</button>
          <button class="role-btn" onclick="showParentMode('join')" id="parent-join-btn">Join Household</button>
        </div>

        <div id="parent-create" class="parent-mode hidden">
          <label>Household name:
            <input id="household-name" placeholder="Enter household name" />
          </label>
          <button class="primary" onclick="createHousehold()">Create</button>
        </div>

        <div id="parent-join" class="parent-mode hidden">
          <label>Join Code:
            <input id="parent-join-code" placeholder="Enter join code" />
          </label>
          <button class="primary" onclick="joinAsParent()">Join</button>
        </div>
      </div>

      <div id="auth-out" class="auth-out" aria-live="polite"></div>
    </section>
  </main>

<script>
  function selectRole(role){
    document.getElementById('child-form').classList.toggle('hidden', role !== 'child');
    document.getElementById('parent-form').classList.toggle('hidden', role !== 'parent');

    // highlight active role button
    document.getElementById('btn-child').classList.toggle('active', role === 'child');
    document.getElementById('btn-parent').classList.toggle('active', role === 'parent');

    // clear outputs and parent modes
    document.getElementById('auth-out').textContent = '';
    showParentMode(null);
  }

  function showParentMode(mode){
    document.getElementById('parent-create').classList.toggle('hidden', mode !== 'create');
    document.getElementById('parent-join').classList.toggle('hidden', mode !== 'join');
    // update active button styles
    document.getElementById('parent-create-btn').classList.toggle('active', mode === 'create');
    document.getElementById('parent-join-btn').classList.toggle('active', mode === 'join');
  }

  async function joinAsChild(){
    const code = document.getElementById('child-join-code').value.trim();
    if(!code){ return showOut('Enter a join code'); }
    showOut('Searching for join code...');
    try{
      const res = await fetch(`/api/login?joinCode=${encodeURIComponent(code)}`);
      if(!res.ok){ const txt = await res.text(); return showOut('Not found: '+txt); }
      const json = await res.json();
      showOut('Joined successfully. Redirecting to household page...');
      localStorage.setItem('joinHousehold', JSON.stringify(json.household || json));
      setTimeout(()=> window.location.href = '/household.html', 600);
    }catch(e){
      showOut('Error contacting server: '+(e.message||e));
    }
  }

  async function joinAsParent(){
    const code = document.getElementById('parent-join-code').value.trim();
    if(!code){ return showOut('Enter a join code'); }
    showOut('Searching for join code...');
    try{
      const res = await fetch(`/api/login?joinCode=${encodeURIComponent(code)}`);
      if(!res.ok){ const txt = await res.text(); return showOut('Not found: '+txt); }
      const json = await res.json();
      showOut('Joined household. Redirecting...');
      localStorage.setItem('joinHousehold', JSON.stringify(json.household || json));
      setTimeout(()=> window.location.href = '/household.html', 600);
    }catch(e){
      showOut('Error contacting server: '+(e.message||e));
    }
  }

  async function createHousehold(){
    const name = document.getElementById('household-name').value.trim();
    if(!name){ return showOut('Enter a household name'); }
    showOut('Creating household...');
    try{
      const res = await fetch('/api/household', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      if(!res.ok){
        const txt = await res.text();
        return showOut('Create failed: '+txt);
      }
      const json = await res.json();
      showOut('Household created. Join code: ' + (json.joinCode ?? json.household?.joinCode ?? 'unknown') );
      localStorage.setItem('joinHousehold', JSON.stringify(json.household || json));
      setTimeout(()=> window.location.href = '/household.html', 900);
    }catch(e){
      showOut('Error contacting server: '+(e.message||e));
    }
  }

  function showOut(txt){
    document.getElementById('auth-out').textContent = txt;
  }
</script>
</body>
</html>